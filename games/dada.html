<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é”é”ç‰¹æ”» - ç°¡åŒ–ç‰ˆ</title>
<style>
  body { margin:0; background:#111; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; color:white; font-family:sans-serif; }
  canvas { background:#222; border:2px solid #fff; }
  #gameOver, #levelUp { position:absolute; text-align:center; width:100%; display:none; }
  #gameOver { top:40%; font-size:2em; }
  #levelUp { top:30%; background:rgba(0,0,0,0.85); padding:20px; }
  button { margin:8px; padding:10px 20px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="600" height="400"></canvas>
<div id="gameOver">ğŸ’€ éŠæˆ²çµæŸï¼æŒ‰ F5 é‡æ–°é–‹å§‹</div>
<div id="levelUp"></div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// ç©å®¶
const player = { x:300, y:200, size:15, speed:3, hp:5, maxHp:5, xp:0, level:1 };

// éŠæˆ²ç‰©ä»¶
const blades = [];
const enemies = [];
const fireZones = [];

let keys = {};
let gameOver = false;
let lastShot = 0;

// æŠ€èƒ½
const skills = [];
const skillList = ["attackSpeed","bladeCount","heal","shield","fireBomb"];
let shieldActive = false;
let shieldTimer = 0;

// äº‹ä»¶
document.addEventListener("keydown", e=>keys[e.key]=true);
document.addEventListener("keyup", e=>keys[e.key]=false);

// åˆ€åˆƒè‡ªå‹•è¿½è¹¤æœ€è¿‘æ•µäºº
function shootBlade(){
  if(enemies.length===0) return;
  let now = Date.now();
  let cooldown = 800;
  if(skills.includes("attackSpeed")) cooldown = 400; 
  if(now - lastShot < cooldown) return;

  let target = enemies.reduce((prev,curr)=>{
    const dx=curr.x-player.x, dy=curr.y-player.y;
    const d = Math.sqrt(dx*dx+dy*dy);
    const pd = Math.sqrt((prev.x-player.x)**2 + (prev.y-player.y)**2);
    return d<pd?curr:prev;
  },enemies[0]);

  let count = skills.includes("bladeCount")?2:1;
  for(let i=0;i<count;i++){
    let angleOffset = (i-0.5*(count-1))*0.2; // å¤šåˆ€åè§’
    const dx = target.x - player.x;
    const dy = target.y - player.y;
    const dist = Math.sqrt(dx*dx+dy*dy);
    const vx = dx/dist*6*Math.cos(angleOffset) - dy/dist*6*Math.sin(angleOffset);
    const vy = dx/dist*6*Math.sin(angleOffset) + dy/dist*6*Math.cos(angleOffset);
    blades.push({x:player.x,y:player.y,size:6,vx,vy});
  }
  lastShot = now;
}

// ç”Ÿæˆæ•µäºº
function spawnEnemy(){
  if(Math.random()<0.02){
    let edge=Math.floor(Math.random()*4);
    let x,y;
    if(edge===0){x=0;y=Math.random()*canvas.height;}
    else if(edge===1){x=canvas.width;y=Math.random()*canvas.height;}
    else if(edge===2){x=Math.random()*canvas.width;y=0;}
    else{x=Math.random()*canvas.width;y=canvas.height;}
    enemies.push({x,y,size:12,speed:1.5,hp:1});
  }
}

// å‡ç´šé¸å–®
function levelUp(){
  player.level++;
  player.xp = 0;
  const lvDiv = document.getElementById("levelUp");
  lvDiv.innerHTML = "<h2>é¸æ“‡ä¸€å€‹æŠ€èƒ½</h2>";
  lvDiv.style.display="block";
  let options=[];
  while(options.length<3){
    const s = skillList[Math.floor(Math.random()*skillList.length)];
    if(!options.includes(s)) options.push(s);
  }
  options.forEach(s=>{
    const btn = document.createElement("button");
    btn.textContent = s==="attackSpeed"?"æ”»é€Ÿæå‡":s==="bladeCount"?"åˆ€åˆƒæ•¸å¢åŠ ":s==="heal"?"å›è¡€":s==="shield"?"è­·ç›¾":s==="fireBomb"?"ç«ç„°ç“¶":"æœªçŸ¥";
    btn.onclick = ()=>{
      if(s==="heal") player.hp=Math.min(player.hp+1,player.maxHp);
      else if(s==="shield") { shieldActive=true; shieldTimer=300; }
      else if(s==="fireBomb"){
        fireZones.push({x:player.x,y:player.y,radius:50,life:300});
      }
      else skills.push(s);
      lvDiv.style.display="none";
    };
    lvDiv.appendChild(btn);
  });
}

// éŠæˆ²é‚è¼¯
function update(){
  if(gameOver) return;
  // ç§»å‹•
  if(keys["ArrowUp"]||keys["w"]) player.y-=player.speed;
  if(keys["ArrowDown"]||keys["s"]) player.y+=player.speed;
  if(keys["ArrowLeft"]||keys["a"]) player.x-=player.speed;
  if(keys["ArrowRight"]||keys["d"]) player.x+=player.speed;
  player.x=Math.max(player.size,Math.min(canvas.width-player.size,player.x));
  player.y=Math.max(player.size,Math.min(canvas.height-player.size,player.y));

  // å°„æ“Š
  shootBlade();

  // åˆ€åˆƒç§»å‹•
  blades.forEach((b,i)=>{
    b.x+=b.vx; b.y+=b.vy;
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) blades.splice(i,1);
  });

  // ç”Ÿæˆæ•µäºº
  spawnEnemy();

  // æ•µäººç§»å‹•
  enemies.forEach((e,ei)=>{
    const dx=player.x-e.x, dy=player.y-e.y, dist=Math.sqrt(dx*dx+dy*dy);
    e.x += dx/dist*e.speed;
    e.y += dy/dist*e.speed;

    // ç©å®¶ç¢°æ’
    if(dist<player.size+e.size){
      enemies.splice(ei,1);
      if(!shieldActive) player.hp--;
      if(player.hp<=0){
        gameOver=true;
        document.getElementById("gameOver").style.display="block";
      }
    }

    // åˆ€åˆƒå‘½ä¸­æ•µäºº
    blades.forEach((b,bi)=>{
      if(Math.hypot(b.x-e.x,b.y-e.y)<e.size+b.size){
        enemies.splice(ei,1);
        blades.splice(bi,1);
        player.xp++;
        if(player.xp>=player.level*5) levelUp();
      }
    });

    // è­·ç›¾å‚·å®³
    if(shieldActive && Math.hypot(player.x-e.x,player.y-e.y)<40){
      enemies.splice(ei,1);
      player.xp++;
      if(player.xp>=player.level*5) levelUp();
    }

    // ç«ç„°å€åŸŸå‚·å®³
    fireZones.forEach(fz=>{
      if(Math.hypot(e.x-fz.x,e.y-fz.y)<fz.radius){
        e.hp -= 0.02;
        if(e.hp<=0){
          const idx = enemies.indexOf(e);
          if(idx!==-1) enemies.splice(idx,1);
          player.xp++;
          if(player.xp>=player.level*5) levelUp();
        }
      }
    });
  });

  // ç«ç„°å€åŸŸå€’æ•¸
  fireZones.forEach((fz,i)=>{
    fz.life--;
    if(fz.life<=0) fireZones.splice(i,1);
  });

  // è­·ç›¾å€’æ•¸
  if(shieldActive){
    shieldTimer--;
    if(shieldTimer<=0) shieldActive=false;
  }
}

// ç•«é¢ç¹ªè£½
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ç©å®¶
  ctx.fillStyle="cyan";
  ctx.beginPath();
  ctx.arc(player.x,player.y,player.size,0,Math.PI*2);
  ctx.fill();

  // è¡€æ¢
  ctx.fillStyle="red";
  ctx.fillRect(10,10,(player.hp/player.maxHp)*100,10);
  ctx.strokeStyle="white";
  ctx.strokeRect(10,10,100,10);

  // åˆ€åˆƒ
  ctx.fillStyle="lime";
  blades.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.size,0,Math.PI*2);
    ctx.fill();
  });

  // è­·ç›¾
  if(shieldActive){
    ctx.strokeStyle="lime";
    ctx.beginPath();
    ctx.arc(player.x,player.y,40,0,Math.PI*2);
    ctx.stroke();
  }

  // ç«ç„°ç“¶
  ctx.fillStyle="orange";
  fireZones.forEach(fz=>{
    ctx.beginPath();
    ctx.globalAlpha = 0.5;
    ctx.arc(fz.x,fz.y,fz.radius,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1.0;
  });

  // æ•µäºº
  ctx.fillStyle="orange";
  enemies.forEach(e=>{
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
    ctx.fill();
  });
}

// éŠæˆ²å¾ªç’°
function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>

</body> </html>
